<!DOCTYPE html>
<html>

<head>
  <title>Affichage des données depuis Google Sheet avec Filtres</title>
  <meta charset="utf-8">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>

<body>
  <div class="py-5 bg-success fs-2 text-white text-center">
    <p class="my-5">Données collectées à partir du formulaire Google</p>
  </div>

  <div class="container mt-5">
    <div id="filter-container" class="mb-3 text-center">
      <label for="filter">Filtrer par question :</label>
      <select id="filter">
        <option value="Tous">Tous</option>
        <option value="film">Film préféré</option>
        <option value="joueur">Joueur préféré</option>
        <option value="club">Club préféré</option>
      </select>
    </div>
    <div id="film-filter-container" class="mb-3 text-center" style="display:none;">
      <label for="film-filter">Sélectionner un film :</label>
      <select id="film-filter">
        <option value="Tous">Tous</option>
      </select>
    </div>
  </div>

  <div class="container mt-5">
    <div id="data-container" class="row"></div>
  </div>

  <script>
    // Remplacez par l'URL de votre Google Sheet
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTBMKiNDRK0N4MoWCQa5oAsy9XW-WhVM4QYZB1mF3Cyn8xQtQpzW7DvRU0ljL3apr0ZaRSrrkCONskh/pub?output=csv';

    // Fonction pour extraire l'ID du fichier Google Drive depuis le lien
    function getGoogleDriveFileID(url) {
      const match = url.match(/id=([a-zA-Z0-9-_]+)/);
      return match ? match[1] : null;
    }

    // Fonction pour extraire les valeurs distinctes de la colonne 'film'
    function getDistinctFilms(data) {
      const films = data.map(row => row.split(',')[3]).filter(film => film !== "");
      return [...new Set(films)];
    }

    // Fonction pour mettre à jour le menu déroulant des films
    function updateFilmFilter(films) {
      const filmFilter = document.getElementById('film-filter');
      filmFilter.innerHTML = '<option value="Tous">Tous</option>';

      films.forEach(film => {
        const option = document.createElement('option');
        option.value = film;
        option.textContent = film;
        filmFilter.appendChild(option);
      });
    }

    // Fonction pour afficher les données en fonction du filtre sélectionné
    function displayData(selectedFilter, selectedFilm = '') {
      fetch(sheetURL)
        .then(response => response.text())
        .then(data => {
          const rows = data.split('\n');
          const container = document.getElementById('data-container');
          container.innerHTML = ""; // Nettoyer le contenu précédent

          for (let i = 1; i < rows.length; i++) {
            const columns = rows[i].split(',');

            const Nom = columns[1];
            const mail = columns[2];
            const film = columns[3];
            const photo = columns[4];
            const jouer = columns[5];
            const club = columns[6];

            const imgId = photo.split('id=')[1];

            // Créez un élément d'image et définissez l'attribut 'src' sur le lien correct pour Google Drive
            const img = document.createElement('img');
            img.className = 'text-center img-fluid mx-auto d-block';
            img.src = `https://drive.google.com/uc?id=${imgId}`;
            img.alt = 'Photos';
            img.style = 'height:200px; object-fit:cover;';

            // Créez un div pour afficher les informations
            const divCol4 = document.createElement('div');
            divCol4.className = 'border p-3 rounded';

            const nomP = document.createElement('p');
            nomP.className = `fs-3 text-center`;
            nomP.innerHTML = `Nom: ${Nom}`;

            const emailP = document.createElement('p');
            emailP.innerHTML = `Adresse e-mail: ${mail}`;

            const filmP = document.createElement('p');
            filmP.innerHTML = `Film préféré: ${film}`;

            const jouerP = document.createElement('p');
            jouerP.innerHTML = `Joueur préféré: ${jouer}`;

            const clubP = document.createElement('p');
            clubP.innerHTML = `Club préféré: ${club}`;


            console.log(film)
            console.log(selectedFilter)
            if (selectedFilter === "film") {
              console.log(selectedFilm)
            }
            // Afficher les informations uniquement si le filtre correspond à "Tous" ou au champ sélectionné
            if (selectedFilter === "Tous" || (selectedFilter === "film" && film === selectedFilm)) {
              divCol4.appendChild(img);
              divCol4.appendChild(nomP);
              divCol4.appendChild(emailP);
              divCol4.appendChild(filmP);
              divCol4.appendChild(jouerP);
              divCol4.appendChild(clubP);

              const divWrapper = document.createElement('div');
              divWrapper.className = 'col-4';

              divWrapper.appendChild(divCol4);
              container.appendChild(divWrapper);
            }
          }
        })
        .catch(error => {
          console.error('Error fetching data:', error);
        });
    }

    // Écouteur d'événements pour le changement de filtre
    const filter = document.getElementById('filter');
    filter.addEventListener('change', () => {
      const selectedFilter = filter.value;
      if (selectedFilter === "Tous") {
        document.getElementById('film-filter-container').style.display = 'none';
        displayData(selectedFilter);
      } else if (selectedFilter === "film") {
        document.getElementById('film-filter-container').style.display = 'block';
        fetch(sheetURL)
          .then(response => response.text())
          .then(data => {
            const rows = data.split('\n');
            const distinctFilms = getDistinctFilms(rows);
            updateFilmFilter(distinctFilms);
            displayData(selectedFilter);
          })
          .catch(error => {
            console.error('Error fetching data:', error);
          });
      } else {
        document.getElementById('film-filter-container').style.display = 'none';
        displayData(selectedFilter);
      }
    });

    // Écouteur d'événements pour le changement de filtre de films
    const filmFilter = document.getElementById('film-filter');
    filmFilter.addEventListener('change', () => {
      const selectedFilm = filmFilter.value;
      displayData('film', selectedFilm);
      location.href = `#${selectedFilm.replace(' ', '')}`; // Rediriger vers la section de filtre
    });

    // Afficher toutes les données initialement
    displayData("Tous");
  </script>
</body>

</html>